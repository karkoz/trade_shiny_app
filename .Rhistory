library(shiny)
library(shinydashboard)
library(shinyWidgets)
library(dplyr)
library(lubridate)
library(ggplot2)
library(plotly)
library(ggthemes)
library(forcats)
library(tidyr)
library(scales)
library(stringr)
library(countrycode)
library(classInt)
library("rnaturalearth")
library("rnaturalearthdata")
library(sf)
library(tmap)
library(leaflet)
library(rgeos)
library(rvest)
library(readr)
library(zoo)
library(rdrop2)
library(ShinyEditor)
Sys.setlocale("LC_TIME", "English")
# wd <- setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
# wd <- sub('\\/app.R$', "", wd)
# setwd(wd)
'%ni%' <- Negate('%in%')
#token <- drop_auth()
#saveRDS(token, file = "token.rds")
token <- readRDS("token.rds")
# read data from dropbox
comtrade_data_2016_2020 <- drop_read_csv("shiny_app/comtrade_data_2016_2020.csv")
#comtrade_data_2016_2020 <- read.csv("comtrade_data_2016_2020.csv")
x <- comtrade_data_2016_2020 %>%
filter(partner %ni% "World") %>%
mutate(Quantity = round(netweight_kg / 1000, 0)) %>%
separate(period, into = c("Year", "Month"), sep = 4)
#
x$Exporters <- toupper(enc2utf8(x$partner))
x$Importer <- toupper(enc2utf8(x$reporter))
#
x$Region <- countrycode(sourcevar = x$Exporters, origin = "country.name", destination = "region")
x$Region <- enc2utf8(x$Region)
x <- x %>% mutate(Date = as.Date(paste(Year, Month, 1, sep = "-")),
Month = lubridate::month(Date, label = T))
x <- x %>% mutate_at("Region", ~replace(., is.na(.), "World"))
x <- x %>% select(Exporters, Date, Quantity, Region, Importer, Year, Month, commodity_code, HS_code_name, HS_code_fullname)
x$Exporters <- x$Exporters %>% str_trim()
#
x$Exporters[x$Exporters == "LAO PEOPLE'S DEMOCRATIC REPUBLIC"] <- "LAO PDR"
x$Exporters[x$Exporters == "LAO PEOPLE'S DEM REP"] <- "LAO PDR"
x$Exporters[x$Exporters == "VIET NAM"] <- "VIETNAM"
x$Exporters[x$Exporters == "HONG KONG, CHINA"] <- "HONG KONG"
x$Exporters[x$Exporters == "UNITED STATES OF AMERICA"] <- "UNITED STATES"
x$Exporters[x$Exporters == "DOMINICAN REPUBLIC"] <- "DOMINICAN REP."
x$Exporters[x$Exporters == "TAIPEI, CHINESE"] <- "TAIWAN"
x$Exporters[x$Exporters == "TANZANIA, UNITED REPUBLIC OF"] <- "TANZANIA"
x$Exporters[x$Exporters == "CZECH REPUBLIC"] <- "CZECH REP."
x$Exporters[x$Exporters == "VENEZUELA, BOLIVARIAN REPUBLIC OF"] <- "VENEZUELA"
x$Exporters[x$Exporters == "SAINT VINCENT AND THE GRENADINES"] <- "ST. VIN. AND GREN."
x$Exporters[x$Exporters == "ESWATINI"] <- "SWAZILAND"
x$Exporters[x$Exporters == "SOUTH SUDAN"] <- "S. SUDAN"
x$Exporters[x$Exporters == "IRAN, ISLAMIC REPUBLIC OF"] <- "IRAN"
x$Exporters[x$Exporters == "SAINT KITTS AND NEVIS"] <- "ST. KITTS AND NEVIS"
x$Exporters[x$Exporters == "RUSSIAN FEDERATION"] <- "RUSSIA"
x$Exporters[x$Exporters == "BOLIVIA, PLURINATIONAL STATE OF"] <- "BOLIVIA"
x$Exporters[x$Exporters == "WESTERN SAHARA"] <- "W. SAHARA"
x$Exporters[x$Exporters == "MACEDONIA, NORTH"] <- "MACEDONIA"
x$Exporters[x$Exporters == "SAO TOME AND PRINCIPE"] <- "SAO TOMÉ AND PRINCIPE"
x$Exporters[x$Exporters == "KOREA, REPUBLIC OF"] <- "KOREA"
x$Exporters[x$Exporters == "MACAO, CHINA"] <- "MACAO"
x$Exporters[x$Exporters == "CHINA, MACAO SAR"] <- "MACAO"
x$Exporters[x$Exporters == "BOSNIA AND HERZEGOVINA"] <- "BOSNIA AND HERZ."
x$Exporters[x$Exporters == "ANTIGUA AND BARBUDA"] <- "ANTIGUA AND BARB."
x$Exporters[x$Exporters == "BRUNEI DARUSSALAM"] <- "BRUNEI"
x$Exporters[x$Exporters == "PALESTINE, STATE OF"] <- "PALESTINE"
x$Exporters[x$Exporters == "FRENCH POLYNESIA"] <- "FR. POLYNESIA"
x$Exporters[x$Exporters == "FRENCH SOUTHERN AND ANTARCTIC TERRITORIES"] <- "FR. S. ANTARCTIC LANDS"
x$Exporters[x$Exporters == "EQUATORIAL GUINEA"] <- "EQ. GUINEA"
x$Exporters[x$Exporters == "CONGO, DEMOCRATIC REPUBLIC OF THE"] <- "DEM. REP. CONGO"
x$Exporters[x$Exporters == "CAYMAN ISLANDS"] <- "CAYMAN IS."
x$Exporters[x$Exporters == "BRITISH INDIAN OCEAN TERRITORY"] <- "BR. INDIAN OCEAN TER."
x$Exporters[x$Exporters == "SOLOMON ISLANDS"] <- "SOLOMON IS."
x$Exporters[x$Exporters == "MARSHALL ISLANDS"] <- "MARSHALL IS."
x$Exporters[x$Exporters == "PITCAIRN"] <- "PITCAIRN IS."
x$Exporters[x$Exporters == "TURKS AND CAICOS ISLANDS"] <- "TURKS AND CAICOS IS."
x$Exporters[x$Exporters == "SYRIAN ARAB REPUBLIC"] <- "SYRIA"
x$Exporters[x$Exporters == "UNITED REP. OF TANZANIA"] <- "TANZANIA"
x$Exporters[x$Exporters == "LAO PEOPLE'S DEM. REP."] <- "LAO PDR"
x$Exporters[x$Exporters == "BOSNIA HERZEGOVINA"] <- "BOSNIA AND HERZ."
x$Exporters[x$Exporters == "REP. OF MOLDOVA"] <- "MOLDOVA"
x$Exporters[x$Exporters == "TFYR OF MACEDONIA"] <- "MACEDONIA"
x$Exporters <- enc2utf8(x$Exporters)
x$Exporters[x$Exporters == "CÔTE D'IVOIRE"] <- "COTE D'IVOIRE"
# remove Austria and Malta due to lack of data avaiability
x <- x %>% filter(Importer %ni% c("AUSTRIA", "MALTA") & Year %ni% c(2015,2020) & Region != "World")
x <- x %>% filter(Date > "2015-12-01" & Date < "2020-01-01")
x$commodity_code <- paste("0" ,x$commodity_code, sep = "")
codes <- x %>%
group_by(commodity_code, HS_code_name) %>%
dplyr::summarise(freq = n()) %>%
mutate(name = paste(commodity_code, " (", HS_code_name, ")", sep = "")) %>%
arrange(commodity_code)
codes_table <- x %>%
group_by(commodity_code, HS_code_fullname) %>%
dplyr::summarise(freq = n()) %>%
arrange(commodity_code) %>%
select(commodity_code, HS_code_fullname)
codes_list <- vector(mode = "list", length = 32)
for (i in 1:nrow(codes)) {
name <- codes$name[i]
code <- codes$commodity_code[i]
names(codes_list)[[i]] <- name
codes_list[[i]] <- code
}
world <- ne_countries(scale = "medium", continent = NULL, returnclass = "sf")
class(world)
world <- world %>% select(4,18,19,25)
world$name <- toupper(world$name)
world$name <- enc2utf8(world$name)
world$name[world$name == "CÔTE D'IVOIRE"] <- "COTE D'IVOIRE"
js <- "
function openFullscreen(elem) {
if (elem.requestFullscreen) {
elem.requestFullscreen();
} else if (elem.mozRequestFullScreen) { /* Firefox */
elem.mozRequestFullScreen();
} else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
elem.webkitRequestFullscreen();
} else if (elem.msRequestFullscreen) { /* IE/Edge */
elem.msRequestFullscreen();
}
}"
css <- "
#ggplot:-webkit-full-screen {
height: 100%;
margin: 0;
}
#ggplot:-ms-fullscreen {
height: 100%;
}
#ggplot:fullscreen {
height: 100%;
}"
my_choices2 <- stringr::str_wrap(names(codes_list), width = 35)
my_choices2 <- stringr::str_replace_all(my_choices2, "\\n", "<br>")
download_text <- function(x) {
temp <- tempfile()
name <- paste("shiny_app/overview", x, ".txt", sep = "")
drop_download("shiny_app/plik.txt", dtoken = token, overwrite = T, local_path = temp)
t <- read_file(temp)
return(t)
}
t <- download_text()
ui <- dashboardPage(
dashboardHeader(title = "Trade data"),
dashboardSidebar(
sidebarMenu(
pickerInput(
inputId = "codes",
label = "Choose a HS code:",
choices = codes_list,
selected = NULL,
options = list(
`live-search` = TRUE),
choicesOpt = list(
content = my_choices2
)
),
menuItem("HS codes fullnames", icon = icon("table"), tabName = "table", badgeLabel = "i", badgeColor = "blue"),
menuItem("Import by months and years", tabName = "plot1", icon = icon("far fa-chart-bar"), selected = TRUE),
menuItem("Top 10 exporters", icon = icon("far fa-chart-bar"), tabName = "plot2"),
menuItem("Exporters map", icon = icon("far fa-map"), tabName = "plot3"),
menuItem("Seasonality", icon = icon("fas fa-chart-line"), tabName = "plot4_1"),
menuItem("Seasonality by country", icon = icon("fas fa-chart-line"), tabName = "plot4"),
menuItem("Import by regions", icon = icon("fas fa-chart-line"), tabName = "plot5"),
menuItem("Import by regions, seasonality", icon = icon("far fa-chart-line"), tabName = "plot6"),
menuItem(p(HTML("Quarterly export<br>by the top 5 exporters")), icon = icon("fas fa-chart-line"), tabName = "plot7"),
menuItem("Heatplot 1", icon = icon("fas fa-border-all"), tabName = "plot8"),
menuItem("Heatplot 2", icon = icon("fas fa-border-all"), tabName = "plot9"),
menuItem("Heatplot 3", icon = icon("fas fa-border-all"), tabName = "plot10"),
menuItem("Export by product groups", icon = icon("fas fa-border-all"), tabName = "plot11")
)
),
dashboardBody(
tabItems(
tabItem(tabName = "table",
dataTableOutput('table')
),
tabItem(tabName = "plot1",
fluidRow(
box(title = "Plot", status = "primary", solidHeader = TRUE,
plotly::plotlyOutput("correlation_plot"), width = 12)
),
fluidRow(  # Setup
use_editor("n2dsgmto6sikj8fwkxsua54ix0j18zcdpifat2lh2q4be3nv"),
# Text Input 1
fluidRow(
column(
width = 12,
editor(id = 'textcontent', text = t),
br(),
actionButton(
"generatehtml",
"Save",
icon = icon("edit")
))
))
),
tabItem(tabName = "plot2",
fluidRow(
column(3,
box(title = "Inputs", status = "warning", solidHeader = TRUE,
checkboxInput("with_or_without3", "Incuding European countries", FALSE),
width = "100%")
),
column(9,
box(title = p("Plot", downloadButton('downloadPlot2', 'Download plot')), status = "primary", solidHeader = TRUE,
plotOutput("top_10exporters_plot"), width = "100%")
)
),
fluidRow(
box(title = "Overview", status = "success", solidHeader = TRUE,
p(textOutput("text2")), width = 12)
),
),
tabItem(tabName = "plot3",
fluidRow(
box(title = "Plot", status = "primary", solidHeader = TRUE,
leafletOutput("export_map_2016_2019"), width = 12
)
),
fluidRow(
box(title = "Overview", status = "success", solidHeader = TRUE,
p(textOutput("text3")), width = 12)
)
),
tabItem(tabName = "plot4_1",
fluidRow(
box(title = p("Plot", downloadButton('downloadPlot4', 'Download plot')), status = "primary", solidHeader = TRUE,
plotOutput("seasonality"), width = 12
)
),
fluidRow(
box(title = "Overview", status = "success", solidHeader = TRUE,
p(textOutput("text4_1")), width = 12)
)
),
tabItem(tabName = "plot4",
fluidRow(
column(6,
box(title = p("Plot", downloadButton('downloadPlot4_1', 'Download plot')), status = "primary", solidHeader = TRUE,
plotOutput("seasonality_by_exporters"), width = "100%"
)
),
column(6,
box(title = p("Plot", downloadButton('downloadPlot4_2', 'Download plot')), status = "primary", solidHeader = TRUE,
plotOutput("seasonality_by_exporters2"), width = "100%"
)
)
),
fluidRow(
box(
title = "Input 1", status = "warning", solidHeader = TRUE,
selectInput("exporters", "Choose a exporter:", ""), width = 6
),
box(
title = "Input 2", status = "warning", solidHeader = TRUE,
selectInput("exporters2", "Choose a exporter:", ""), width = 6
)
),
fluidRow(
box(title = "Overview", status = "success", solidHeader = TRUE,
p(textOutput("text4")), width = 12)
)
),
tabItem(tabName = "plot5",
fluidRow(
column(3,
box(title = "Inputs", status = "warning", solidHeader = TRUE,
pickerInput(
inputId = "multipleRegions",
label = "Select regions:",
choices = c("Sub-Saharan Africa", "Europe & Central Asia",
"Middle East & North Africa", "South Asia",
"Latin America & Caribbean", "North America",
"East Asia & Pacific"),
multiple = TRUE,
selected = c("Sub-Saharan Africa", "Europe & Central Asia",
"Middle East & North Africa", "South Asia",
"Latin America & Caribbean", "North America",
"East Asia & Pacific")
),
width = "100%")
),
column(9,
box(title = p("Plot", downloadButton('downloadPlot5', 'Download plot')), status = "primary", solidHeader = TRUE,
plotOutput("import_by_regions"), width = "100%")
)
),
fluidRow(
box(title = "Overview", status = "success", solidHeader = TRUE,
p(textOutput("text5")), width = 12)
)
),
tabItem(tabName = "plot6",
fluidRow(
column(3,
box(title = "Inputs", status = "warning", solidHeader = TRUE,
selectInput("regions", "Choose a region:", c("All", "Sub-Saharan Africa", "Europe & Central Asia",
"Middle East & North Africa", "South Asia",
"Latin America & Caribbean", "North America",
"East Asia & Pacific")),
width = "100%")
),
column(9,
box(title = p("Plot", downloadButton('downloadPlot6', 'Download plot')), status = "primary", solidHeader = TRUE,
plotOutput("import_by_reg_seasonality"), width = "100%")
)
),
fluidRow(
box(title = "Overview", status = "success", solidHeader = TRUE,
p(textOutput("text6")), width = 12)
),
),
tabItem(tabName = "plot7",
fluidRow(
column(3,
box(title = "Inputs", status = "warning", solidHeader = TRUE,
checkboxInput("with_or_without1", "Incuding European countries", FALSE),
width = "100%")
),
column(9,
box(title = p("Plot", downloadButton('downloadPlot7', 'Download plot')), status = "primary", solidHeader = TRUE,
plotOutput("top5exp"), width = "100%")
)
),
fluidRow(
box(title = "Overview", status = "success", solidHeader = TRUE,
p(textOutput("text7")), width = 12)
),
),
tabItem(tabName = "plot8",
fluidRow(
column(3,
box(title = "Inputs", status = "warning", solidHeader = TRUE,
checkboxInput("with_or_without2", "Incuding European countries", FALSE),
width = "100%")
),
column(9,
box(title = p("Plot", downloadButton('downloadPlot8', 'Download plot')), status = "primary", solidHeader = TRUE,
plotOutput("heatplot1"),
width = "100%")
)
),
fluidRow(
box(title = "Overview", status = "success", solidHeader = TRUE,
p(textOutput("text8")), width = 12)
)
),
tabItem(tabName = "plot9",
fluidRow(
column(3,
box(title = "Inputs", status = "warning", solidHeader = TRUE,
selectInput("top10exporters", "Choose from Top10 esporters:", ""),
width = "100%")
),
column(9,
box(title = p("Plot", downloadButton('downloadPlot9', 'Download plot')), status = "primary", solidHeader = TRUE,
plotOutput("heatplot2"),
width = "100%")
)
),
fluidRow(
box(title = "Overview", status = "success", solidHeader = TRUE,
p(textOutput("text9")), width = 12)
)
),
tabItem(tabName = "plot10",
fluidPage(
tags$head(
tags$script(HTML(js)),
tags$style(HTML(css))
),
br(),
fluidRow(
column(3,
box(title = "Inputs", status = "warning", solidHeader = TRUE,
checkboxInput("with_or_without3", "Incuding European countries", FALSE),
width = "100%")
),
column(9,
box(title = p("Plot", downloadButton('downloadPlot10', 'Download plot'), actionButton(
"fs", "", icon = icon("fas fa-expand-arrows-alt", "fas-2x"),
onclick = "openFullscreen(document.getElementById('top_10exporters_plot'));"
)), status = "primary", solidHeader = TRUE,
plotOutput("heatplot3"),
width = "100%")
)
),
fluidRow(
box(title = "Overview", status = "success", solidHeader = TRUE,
p(textOutput("text10")), width = 12)
)
)
),
tabItem(tabName = "plot11",
fluidRow(
column(12,
tabsetPanel(position = "below",
tabPanel("Tab 1",
fluidRow(
box(title = "Plot", status = "primary", solidHeader = TRUE,
plotly::plotlyOutput("compare_product"), width = 12
)
),
fluidRow(
box(title = "Overview", status = "success", solidHeader = TRUE,
p(textOutput("text11")), width = 12)
)
),
tabPanel("Tab 2",
fluidRow(
box(title = "Plot", status = "primary", solidHeader = TRUE,
plotly::plotlyOutput("compare_product_by_region"), width = 12
)
),
fluidRow(
box(title = "Overview", status = "success", solidHeader = TRUE,
p(textOutput("text12")), width = 12)
)
),
tabPanel("Tab 3",
fluidRow(
column(3,
box(title = "Inputs", status = "warning", solidHeader = TRUE,
pickerInput(
inputId = "multipleCodes",
label = "Select product codes:",
choices = codes_list,
multiple = TRUE,
choicesOpt = list(
content = my_choices2
)
),
width = "100%")
),
column(9,
box(title = p("Plot", downloadButton('downloadPlot11', 'Download plot')), status = "primary", solidHeader = TRUE,
plotOutput("import_by_product_codes"),
width = "100%")
)
),
fluidRow(
box(title = "Overview", status = "success", solidHeader = TRUE,
p(textOutput("text13")), width = 12)
)
)
))
)
)
)
)
)
codes_list
runApp()
runApp()
